{% extends 'base.html' %}
{% block title %}Plans manager{% endblock %}
{% block dashboard_name %}Plans manager{% endblock %}
{% block body %}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4 text-primary">Plans</h2>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="plan_id" name="plan_id" value="{{ request.plan.id }}">
                        <div class='row'>
                            <div class="col-md-12">
                                <div class="mb-8" style="align-items: center;">
                                    <select name="" id="plan_selector" class="form-control mx-auto d-block" style="width: 50%;">
                                        <option value="">Create a new plan</option>
                                    </select>                        
                                </div>
                                 <br>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Column 1 -->
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="plan_name" class="form-label">Plan name</label>
                                    <input type="text" class="form-control" value="{{ user.first_name }}" id="plan_name" name="plan_name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="price" class="form-label">Price</label>
                                    <input step="0.01" type="number" class="form-control" value="{{ user.username }}" id="price" name="price" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="duration" class="form-label">Duration</label>
                                    <select class="form-control" name="duration" id="duration">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Column 2 -->
                            <div class="col-md-12">
                                <div class="mb-12">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description">{{ user.phone }}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid mt-4 offset-md-5">
                            <button class="btn btn-primary btn-lg" id="update">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const usersData = {
        {% for user in Users %}
            "{{ user.id }}": {
                "first_name": "{{ user.first_name|escapejs }}",
                "username": "{{ user.username|escapejs }}",
                "email": "{{ user.email|escapejs }}",
                "phone": "{{ user.phone|escapejs }}",
                "profile_picture": "{{ user.profile_picture.url|escapejs }}"
            },
        {% endfor %}
    };
</script>
<script>
    const selector = document.getElementById('update');
    selector.addEventListener('click', function (event) {
        event.preventDefault();
        const selectedId = this.value;
        if (selectedId != "") {
            console.log("fix here");
        }
        else{
            var plan_name = document.getElementById('plan_name').value;
            var price = document.getElementById('price').value;
            var duration = document.getElementById('duration').value;
            var description = document.getElementById('description').value;

            fetch('/plans', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'plan_name': plan_name,
                    'price': price,
                    'duration': duration,
                    'description': description
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    window.location.href = '/plans/';
                })
        }

    });

    document.addEventListener('DOMContentLoaded', function () {
        const userSelect = document.getElementById('userSelect');

        userSelect.addEventListener('change', function () {
            const selectedId = this.value;
            const user = usersData[selectedId];

            if (user) {
                document.getElementById('first_name').value = user.first_name;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('phone').value = user.phone;
                document.getElementById('profile_picture').src = user.profile_picture;
            }
            document.getElementById('user_id').value = selectedId;

        });
    });

</script>


{% endblock %}